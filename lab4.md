## Урок: Designing Aggregates in DDD

### Заказчик дополнил требования к TaskManager

Участники проекта могут создавать “статусы” внутри конкретного проекта, передавая название статуса и цвет для отображения в UI. “Статус” отображает, в какой стадии выполнения находятся задачи с таким статусом. Поэтому участники могут присваивать статус задаче и изменять статус задачи в дальнейшем.

В каждом проекте есть **статус по умолчанию (default status). Его значение "**CREATED".

На UI это планируется визуализировать как “доску” / таблицу, где названия колонок - это имена статусов в проекте, а содержимое колонок - задачи с соответствующим статусом.

Конечно, статусы можно и удалять. Но удалить можно только такие статусы, которые **не присвоены ни одной задаче в проекте**. (колонка пустая).

Кроме того, статусы в проекте отсортированы по какому-то критерию и участники в любой момент могут поменять порядок статусов внутри проекта (порядок колонок). **[Опциональное требование - вы не обязаны его выполнять]

### Задание к уроку

1. **Дополните** функциональные **требования**, **языки,** **контексты** и **сущности**, в соответствие с этими требованиями.
2. Выделите агрегаты для Task Manager по следующему сценарию:

   **1.** Пройдитесь по всем операциям **в функциональных требованиях,** для каждой из них укажите, **какие сущности** **требуют изменений** для ее выполнения. Возможно, есть сущности не изменяются в рамках операции, но тем не менее влияют на ее выполнение?

   **2.** Аналогично, укажите названия **ограниченных контекстов**, которые будут **задействованы** **в** каждой функциональной **операции**.

   **3.** Проанализируйте, какие **инварианты** требуется поддержать при обновлении сущностей. Есть ли такие инварианты или нет, в чем они заключаются. Если **инварианты есть - выпишите их там же**, рядом с функциональной операцией.  Напоминаю, что инвариант - это некоторое условие, которое должно оставаться неизменным в любой момент времени.

   Для операций, которые требуют **обновления** **более одной сущности**, необходимо понять - требуются ли **свойства** **транзакционности** для их обновления.

   **4.** Теперь ваша задача - понять, **требуют ли ваши инварианты строгой согласованности** или бизнес вполне может перенести и  **согласованность в конечном счете**. Для этого вы можете описать ваше мнение по этому поводу и воспользоваться **помощью ментора!!!**, обсудить какая согласованность и где может быть применена.

   **5.** И последнее - на основе проделанного вами анализа вы можете принять решение какие сущности будут объединены в какие агрегаты. **Определив состав агрегатов, соберите их в таблицу**, указав их название, состав (сущность / сущности), ограниченный контекст. Состав сущностей тоже может претерпеть изменения, это нормально.

## Изменение проектной документации после дополнения требований

### Вопросы

1. Какие права доступа требуются для создания и удаления статусов?
2. Как участники проекта могут изменить порядок статусов?
3. Какие ограничения существуют для имен статусов?
4. Как будет реализована визуализация статусов и задач на UI?

### Ubiquitous language

Дополните таблицу новыми терминами.

| Термин           | Краткое пояснение                                                       | Атрибуты                       | Ассоциированные термины | Действия над предметом                         |
|------------------|------------------------------------------------------------------------|--------------------------------|-------------------------|------------------------------------------------|
| Статус (Status)  | Название статуса, отображающего состояние задачи в проекте.           | ID: UUID, name: String, color: String | Задача                  | Создание статуса, Изменение статуса, Удаление статуса |
| Дефолтный статус (Default Status) | Статус, который назначается задачам по умолчанию.          | Статус: String                 | Задача                         | Назначение статуса по умолчанию                 |
| Порядок статусов (Status Order) | Порядок, в котором статусы отображаются на UI.            | Порядок: List[UUID]            |    Задача                      | Изменение порядка статусов                     |

### Ограниченные контексты

Дополните таблицу новыми контекстами, если требуется

| Название контекста                           | Краткое пояснение, если требуется                     | Язык контекста                               |
|-----------------------------------------------|------------------------------------------------------|-----------------------------------------------|
| Управление статусами (Status Management)     | Контекст, в котором осуществляются операции со статусами. | Статус, Создание статуса, Удаление статуса, Изменение статуса, Порядок статусов, Дефолтный статус |

### Сущности

Дополните таблицу новыми сущностями, внесите изменения в существующие, если считаете нужным

| Сущность         | Атрибуты                                                                                       | Пояснения, если необходимы по вашему мнению | Контекст                 |
|-------------------|------------------------------------------------------------------------------------------------|---------------------------------------------|--------------------------|
| Статус (Status)   | ID: UUID, name: String, color: String                                                       | Содержит информацию о статусе задачи.       | Status Management         |
| Проект (Project)  | ID: UUID, name: String, description: String, participants: List[User ID], statuses: List[Status ID] | Объединяет участников, задачи и статусы.   | Project Management        |

## Выделение агрегатов

### Какие сущности и контексты задействованы в функциональных операциях системы

| Ссылка на функциональное требование                  | Сущности, которые меняются, инварианты, вид согласованности                                | Контекст               |
|------------------------------------------------------|-----------------------------------------------------------------------------------------------|------------------------|
| Создание статуса                                     | Status, Project. Инвариант: Статус не может быть пустым. Статусы не могут дублироваться. Согласованность: строгая | Status Management       |
| Удаление статуса                                     | Status, Project. Инвариант: Статус можно удалить только если он не присвоен задачам. Согласованность: конечная | Status Management       |
| Изменение статуса                                    | Status, Task. Инвариант: Задача может иметь только один статус в каждый момент времени. Согласованность: строгая | Status Management         |
| Изменение порядка статусов                           | Project. Инвариант: Порядок статусов должен оставаться валидным и не нарушать логику отображения. Согласованность: конечная | Status Management       |

### Сущности, изменения
| Сущность       | Атрибуты                                                                                      | Пояснения, если необходимы по вашему мнению                           | Контекст            |
|----------------|------------------------------------------------------------------------------------------------|----------------------------------------------------------------------|---------------------|
| Task Status | - ID: UUID, - status: String, - color: String, - updated_at: DateTime                       | Добавлен атрибут color для отображения статуса в UI.             | Task Management      |
| Project     | - ID: UUID, - name: String, - description: String, - participants: List[User ID], - default_status: Task Status, - statuses: List[Task Status] | Добавлены атрибуты default_status и statuses для управления статусами в проекте. | Project Management    |

### Агрегаты

| Агрегат             | Атрибуты и сущности                                                                                   | Пояснения, если необходимы по вашему мнению | Контекст                |
|----------------------|-------------------------------------------------------------------------------------------------------|--------------------------------------------|-------------------------|
| Project               | ID: UUID, name: String, description: String, participants: List[User ID], statuses: List[Status ID] | Содержит статусы и участников проекта     | Project Management       |
| Status                | ID: UUID, name: String, color: String                                                              | Содержит информацию о статусах задач       | Status Management        |